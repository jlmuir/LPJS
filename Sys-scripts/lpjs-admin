#!/bin/sh -e

##########################################################################
#   Script description:
#       Menu for basic LPJS setup
#       
#   History:
#   Date        Name        Modification
#   2021-10-06  J Bacon     Begin
##########################################################################

usage()
{
    printf "Usage: $0\n"
    exit 1
}


##########################################################################
#   Function description:
#       Pause until user presses return
##########################################################################

pause()
{
    local junk
    
    printf "Press return to continue..."
    read junk
}


##########################################################################
#   Main
##########################################################################

if [ $# != 0 ]; then
    usage
fi

conf_file=$(auto-localbase)/etc/lpjs/config

# Prevent user from running a Trojan as root in the case their account
# was compromised
absolute="$(which $0)"
# Don't count on -e being set at this point
if ! auto-file-secure "$absolute"; then
    exit 1
fi

if ! auto-root-check $0; then
    printf "Root "
    # exec quotes '$absolute --flag', causing usage error
    # Assigning to cmd works around the problem
    cmd="$absolute $@"
    exec su -m root -c "$cmd"
fi

: ${EDITOR:=vi}

while true
do
    clear
    lpjs-banner
    cat << EOM

1.. Set up a zero-configuration one-node cluster on this machine
2.. Generate configuration file (Usually done only on head node, or by SPCM)
3.. Copy configuration file from head node (typically done by SPCM)
4.. Edit config file
5.. Enable dispatch daemon (make this the head node)
6.. Enable compute daemon (make this a compute node)
7.. Restart daemon
Q.. Quit

EOM

    read -p 'Selection? ' resp
    case 0$resp in
    01)
	printf "Not yet implemented.\n"
	;;
    
    02)
	if [ -e $conf_file ]; then
	    printf "$conf_file already exists.  Overwrite? y/[n] "
	    read generate
	else
	    generate=y
	fi
	if [ 0"$generate" = 0y ]; then
	    read -p "Host name of head node? " head_host
	    read -p "Host names of compute nodes (comma-separated) " compute_hosts
	    cat << EOM > $conf_file
head    $head_host
compute $compute_hosts
EOM
	fi
	$EDITOR $conf_file
	;;

    03)
	read -p 'Host name of head node? ' head_host
	read -p 'Username for ssh to head node (usually ssh does not accept root)? ' user_name
	if [ -e $conf_file ]; then
	    printf "$conf_file already exists.  Overwrite? y/[n] "
	    read overwrite
	else
	    overwrite=y
	fi
	if [ 0"$overwrite" = 0y ]; then
	    remote_conf=$(ssh $user_name@$head_host auto-localbase)/etc/lpjs/config
	    #echo $remote_conf
	    scp $user_name@$head_host:$remote_conf $conf_file
	fi
	pause
	;;
    
    04)
	$EDITOR $(auto-localbase)/etc/lpjs/config
	;;
    
    05)
	if grep -q '^head' $conf_file; then
	    head_node=$(awk '$1 == "head" { print $2 }' $conf_file)
	    printf "This node currently lists $head_node as the head node.\n"
	    printf "$head_node will be replaced by $(hostname).\n"
	    printf "Proceed? y/[n] "
	    read proceed
	    if [ 0"$proceed" != 0y ]; then
		break
	    fi
	fi
	head_node=$(hostname)
	printf "head    $head_node\n" >> $conf_file.temp
	grep -v '^head' $conf_file >> $conf_file.temp || true
	mv -f $conf_file.temp $conf_file
	auto-enable-service lpjs_dispatchd $0
	pause
	;;

    06)
	if [ ! -e $conf_file ] || ! grep -q '^head' $conf_file; then
	    printf "Host name of head node? "
	    read head_node
	    printf "head    $head_node\n" >> $conf_file
	fi
	auto-enable-service lpjs_compd $0
	pause
	;;

    07)
	# FIXME: Maybe make auto-service-restart wrapper for portability
	if auto-service-enabled lpjs_compd; then
	    service lpjs_compd restart;
	fi
	if auto-service-enabled lpjs_dispatchd; then
	    service lpjs_dispatchd restart;
	fi
	pause
	;;
    
    0Q|0q)
	exit 0
	;;

    *)
	printf "Invalid option: $resp\n"
    esac
done
